name: ci

permissions:
  contents: write

on:
  push:
    branches: [ "main", "cmake-support" ]
  pull_request:
    branches: [ "main", "cmake-support" ]
  release:
    types: [ "created" ]

jobs:
  build:
    name: build-and-test-${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
          - os: ubuntu-latest
            compiler: clang
          - os: windows-latest
            compiler: gcc

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: Configure (CMake) - Ubuntu + gcc
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'gcc'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
      shell: bash

    - name: Configure (CMake) - Ubuntu + clang
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
      shell: bash

    - name: Configure (CMake) - Windows (gcc)
      if: matrix.os == 'windows-latest'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -G "MinGW Makefiles"
      shell: pwsh

    - name: Build (CMake) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release -- -j2
      shell: bash

    - name: Build (CMake) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release -- -j2
      shell: pwsh

    - name: Run tests (CTest) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release --target test
        CTEST_OUTPUT_ON_FAILURE=1 ctest --test-dir build -C Release
      shell: bash

    - name: Show test program output - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "=== Program Test Output ==="
        cat Testing/Temporary/LastTest.log
      shell: bash
      working-directory: build

    - name: Run tests (CTest) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release --target test
        $env:CTEST_OUTPUT_ON_FAILURE=1; ctest --test-dir build -C Release
      shell: pwsh

    - name: Show test program output - Windows
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "=== Program Test Output ==="
        Get-Content Testing/Temporary/LastTest.log
      shell: pwsh
      working-directory: build

    - name: Check output files content - Linux
      if: matrix.os == 'ubuntu-latest'
      continue-on-error: true
      run: |
        echo "=== Contents of first.analyzed.pgn ==="
        cat ./pgn_samples/first.analyzed.pgn
        echo "=== Contents of first.stats.txt ==="
        cat ./pgn_samples/first.stats.txt
      shell: bash

    - name: Check output files content - Windows
      if: matrix.os == 'windows-latest'
      continue-on-error: true
      run: |
        Write-Host "=== Contents of first.analyzed.pgn ==="
        Get-Content ./pgn_samples/first.analyzed.pgn
        Write-Host "=== Contents of first.stats.txt ==="
        Get-Content ./pgn_samples/first.stats.txt
      shell: pwsh

    - name: Verify expected output files (CMake script) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake -P cmake/check_outputs.cmake -DPROJECT_SOURCE_DIR=${{ github.workspace }}
      shell: bash

    - name: Verify expected output files (CMake script) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake -P cmake/check_outputs.cmake -DPROJECT_SOURCE_DIR=${{ github.workspace }}
      shell: pwsh

    - name: Create package (CPack) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release --target package
      shell: bash

    - name: Create package (CPack) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release --target package
      shell: pwsh

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: apgn-package-${{ matrix.os }}
        path: |
          build/*.zip

  release:
    name: build-and-upload-release-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'release' && github.event.action == 'created'

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
          - os: ubuntu-latest
            compiler: clang
          - os: windows-latest
            compiler: gcc

    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: Configure (CMake) - Ubuntu + gcc (release)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'gcc'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
      shell: bash

    - name: Configure (CMake) - Ubuntu + clang (release)
      if: matrix.os == 'ubuntu-latest' && matrix.compiler == 'clang'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
      shell: bash

    - name: Configure (CMake) - Windows (gcc) (release)
      if: matrix.os == 'windows-latest'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -G "MinGW Makefiles"
      shell: pwsh

    - name: Build (CMake) - Linux (release)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release -- -j2
      shell: bash

    - name: Build (CMake) - Windows (release)
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release -- -j2
      shell: pwsh

    - name: Run tests (release) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release --target test || true
        CTEST_OUTPUT_ON_FAILURE=1 ctest --test-dir build -C Release
      shell: bash

    - name: Show test program output (release) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "=== Program Test Output ==="
        cat Testing/Temporary/LastTest.log
      shell: bash
      working-directory: build

    - name: Run tests (release) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release --target test || true
        $env:CTEST_OUTPUT_ON_FAILURE=1; ctest --test-dir build -C Release
      shell: pwsh

    - name: Show test program output (release) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "=== Program Test Output ==="
        Get-Content Testing/Temporary/LastTest.log
      shell: pwsh
      working-directory: build

    - name: Create package (CPack) - Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake --build build --config Release --target package
      shell: bash

    - name: Create package (CPack) - Windows
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build build --config Release --target package
      shell: pwsh

    - name: upload zip to release assets
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ runner.os == 'Windows' && 'apgn-windows.zip' || 'apgn-linux.zip' }}
        asset_name: ${{ runner.os == 'Windows' && 'apgn-windows.zip' || 'apgn-linux.zip' }}
        asset_content_type: application/zip
      # GITHUB_TOKEN is automatically provided in the runner, no need to pass explicitly
